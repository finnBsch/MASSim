<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Multi-Agent Simulation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<!--<script>-->
<!--    // var Module = {-->
<!--    //     onRuntimeInitialized: function() {-->
<!--    //         console.log('lerp result: ' + Module.lerp(1, 2, 0.5));-->
<!--    //     }-->
<!--    // };-->
<!--</script>-->
<div id="container">
    <canvas id="simulationCanvas"></canvas>
    <div id="controls">
        <div style="text-align: right; display: flex; align-items: center;">
            <label for="speed">Speed:</label>
            <input type="range" id="speed" min="1" max="20" value="10">
            <span id="speedIndicator">10</span>
        </div>
        <div style="text-align: right; display: flex; align-items: center;">
            <label for="numAgents">Number of Agents:</label>
            <input type="range" id="numAgents" min="100" max="500" value="200" step="100" list="tickmarks">
            <datalist id="tickmarks">
                <option value="100" label="100"></option>
                <option value="200"></option>
                <option value="300"></option>
                <option value="400"></option>
                <option value="500" label="500"></option>
            </datalist>
            <span id="numAgentsIndicator">200</span>
        </div>
        <div style="text-align: right;">
            <button id="resetBtn">Reset</button>
        </div>
    </div>
</div>
<script src="mas_sim.js"></script>
<script>
    Module.onRuntimeInitialized = _ => {
        // console.log(sim.nAgents()); // prints 22
        const canvas = document.getElementById('simulationCanvas');
        var speedSlider = document.getElementById('speed');
        var nASlider = document.getElementById('numAgents');
        const speedIndicator = document.getElementById('speedIndicator');
        const numAgentsIndicator = document.getElementById('numAgentsIndicator');

        speedSlider.oninput = function() {
            setSpeed(this.value);
            speedIndicator.textContent = this.value;
        }
        nASlider.oninput = function() {
            setNumAgents(this.value);
            numAgentsIndicator.textContent = this.value;

        }

        const ctx = canvas.getContext('2d');
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        const ratio = window.innerWidth/window.innerHeight;
        var f1 = 1;
        var f2 = 1;
        if (ratio > 1){
            f2 = 1/ratio;
        }
        else {
            f1 = ratio;
        }
        const sim = new Module.MASSim(200, 15*f1, 15*f2);
        ctx.beginPath();
        ctx.setTransform(window.innerWidth/15/f1, 0, 0, window.innerHeight/15/f2, 0, 0);

        // canvas.width = 1000;
        // canvas.height = 1000;

        const speedInput = document.getElementById('speed');
        const resetBtn = document.getElementById('resetBtn');

        let agents = sim.getAgents();
        var animationId;
        function getMethods(obj) {
            var result = [];
            for (var id in obj) {
                try {
                    if (typeof(obj[id]) == "function") {
                        result.push(id + ": " + obj[id].toString());
                    }
                } catch (err) {
                    result.push(id + ": inaccessible");
                }
            }
            return result;
        }
        function drawAgents() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ctx.setTransform(100, 0, 0, 100, 0, 0);
            const nagents= sim.nAgents();
            for (let i = 0; i < nagents; i++) {
                const agent = agents.get(i);
                // alert(getMethods(agent).join("\n"));

                ctx.beginPath();
                ctx.arc(agent[0], agent[1], .04, 0, 2 * Math.PI);
                ctx.fillStyle = agent.color;
                ctx.fill();
            }
            // console.log(performance.now())
            animationId = requestAnimationFrame(drawAgents);
        }
        function updateSimulation() {
            // var t = performance.now();
            sim.step();
            // console.log(performance.now() - t);
            agents = sim.getAgents();
            // console.log(performance.now() - t);
            // console.log("---")
            setTimeout(updateSimulation, 20);
        }

        function resetSimulation() {

            // cancelAnimationFrame(animationId);
            sim.reset();
            // agents = sim.getAgents();
            // updateSimulation();
        }
        function setSpeed(speed){
            sim.setSpeed(speed/2);
            // console.log(speed.value);
        }
        function setNumAgents(input){
            sim.setNumAgents(input);
            agents = sim.getAgents();
            // console.log(speed.value);
        }
        setTimeout(updateSimulation, 20);
        animationId = requestAnimationFrame(drawAgents);
        // speedInput.addEventListener('input', setSpeed);
        resetBtn.addEventListener('click', resetSimulation);
        ctx.restore()
    };
</script>
</body>
</html>