<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Multi-Agent Simulation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<!--<script>-->
<!--    // var Module = {-->
<!--    //     onRuntimeInitialized: function() {-->
<!--    //         console.log('lerp result: ' + Module.lerp(1, 2, 0.5));-->
<!--    //     }-->
<!--    // };-->
<!--</script>-->
<div id="container">
    <canvas id="simulationCanvas"></canvas>
    <div id="controls">
        <div style="text-align: right; display: flex; align-items: center;">
            <label for="speed">Speed:</label>
            <input type="range" id="speed" min="1" max="20" value="10">
            <span id="speedIndicator">10</span>
        </div>
        <div style="text-align: right; display: flex; align-items: center;">
            <label for="perception">Perception Radius:</label>
            <input type="range" id="perception" min="0.2" max="20.0" value="0.2" step="0.05">
<!--            <span id="perceptionIndicator">0.2</span>-->
        </div>
        <div style="text-align: right; display: flex; align-items: center;">
            <label for="numAgents">Number of Agents:</label>
            <input type="range" id="numAgents" min="100" max="500" value="200" step="100" list="tickmarks">
            <datalist id="tickmarks">
                <option value="100" label="100"></option>
                <option value="200"></option>
                <option value="300"></option>
                <option value="400"></option>
                <option value="500" label="500"></option>
            </datalist>
            <span id="numAgentsIndicator">200</span>
        </div>
        <div style="text-align: right;">
            <button id="resetBtn">Reset</button>
        </div>
    </div>
</div>
<script src="mas_sim.js"></script>
<script>
    Module.onRuntimeInitialized = _ => {
        // console.log(sim.nAgents()); // prints 22
        const canvas = document.getElementById('simulationCanvas');
        var speedSlider = document.getElementById('speed');
        var perceptionSlider = document.getElementById('perception');
        var nASlider = document.getElementById('numAgents');
        const speedIndicator = document.getElementById('speedIndicator');
        const numAgentsIndicator = document.getElementById('numAgentsIndicator');
        // const perceptionIndicator = document.getElementById('perceptionIndicator');
        var agent_id_center = -1;
        var agent1 = -1;
        var agent2 = -1;
        speedSlider.oninput = function() {
            setSpeed(this.value);
        }
        nASlider.oninput = function() {
            setNumAgents(this.value);
        }
        perceptionSlider.oninput = function() {
            setPerceptionRadius(this.value)
        }
        function getWindowToCanvas(canvas, x, y) {
            var rect = canvas.getBoundingClientRect();
            var screenX = (x - rect.left) * (canvas.width / rect.width);
            var screenY = (y - rect.top) * (canvas.height / rect.height);
            const ctx = canvas.getContext("2d");
            var transform = ctx.getTransform();
            if (transform.isIdentity) {
                return {
                    x: screenX,
                    y: screenY
                };
            } else {
                //   console.log(transform.invertSelf()); //don't invert twice!!
                const invMat = transform.invertSelf();

                return {
                    x: (screenX * invMat.a + screenY * invMat.c + invMat.e),
                    y: (screenX * invMat.b + screenY * invMat.d + invMat.f)
                };
            }
        }
        mousePos = {x: 0.0, y: 0.0};
        canvas.addEventListener('mousedown', function(event) {
            var x = event.pageX - canvas.offsetLeft
            var y = event.pageY - canvas.offsetTop;
            mousePos = getWindowToCanvas(canvas, x, y);
            const ids = sim.getFocusAgent(mousePos.x, mousePos.y);
            agent_id_center = ids[0];
            agent1 = ids[1];
            agent2 = ids[2];
        })
        const ctx = canvas.getContext('2d');
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        const ratio = window.innerWidth/window.innerHeight;
        var f1 = 1;
        var f2 = 1;
        if (ratio > 1){
            f2 = 1/ratio;
        }
        else {
            f1 = ratio;
        }
        const sim = new Module.MASSim(200, 15*f1, 15*f2);
        ctx.beginPath();
        ctx.setTransform(window.innerWidth/15/f1, 0, 0, window.innerHeight/15/f2, 0, 0);

        // canvas.width = 1000;
        // canvas.height = 1000;

        const speedInput = document.getElementById('speed');
        const resetBtn = document.getElementById('resetBtn');

        let agents = sim.getAgents();
        var animationId;
        setSpeed(speedSlider.value)
        setNumAgents(nASlider.value)
        setPerceptionRadius(perceptionSlider.value)
        function getMethods(obj) {
            var result = [];
            for (var id in obj) {
                try {
                    if (typeof(obj[id]) == "function") {
                        result.push(id + ": " + obj[id].toString());
                    }
                } catch (err) {
                    result.push(id + ": inaccessible");
                }
            }
            return result;
        }
        function drawAgents() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ctx.setTransform(100, 0, 0, 100, 0, 0);
            const nagents= sim.nAgents();
            for (let i = 0; i < nagents; i++) {
                if (agent_id_center != -1){
                    ctx.fillStyle = "#e5e5e5";
                    ctx.strokeStyle = "#1c1c1c";
                }
                else {
                    ctx.fillStyle = "#1c1c1c";
                    ctx.strokeStyle = "#1c1c1c";
                }

                const agent = agents.get(i);
                // alert(getMethods(agent).join("\n"));

                ctx.beginPath();
                ctx.arc(agent[0], agent[1], .04, 0, 2 * Math.PI);
                if (i == agent_id_center){
                    ctx.fillStyle = "#d72525"; //blue
                }
                else if (i == agent1 || i == agent2){
                    ctx.fillStyle = "#3c9156";
                }
                ctx.fill();
            }
            if (agent_id_center != -1){
                const agent = agents.get(agent_id_center);
                ctx.beginPath();
                ctx.arc(agent[0], agent[1], perceptionSlider.value, 0, 2 * Math.PI);
                ctx.strokeStyle = "#a8a8a8";
                ctx.lineWidth = 0.01;
                ctx.stroke();
            }
            ctx.fillStyle = "#1c1c1c";
            ctx.strokeStyle = "#1c1c1c";
            // console.log(performance.now())
            animationId = requestAnimationFrame(drawAgents);
        }
        function updateSimulation() {
            // var pos = getMousePos(canvas, evt);

            // var t = performance.now();
            sim.step();
            // console.log(performance.now() - t);
            agents = sim.getAgents();
            // console.log(performance.now() - t);
            // console.log("---")
            setTimeout(updateSimulation, 20);
        }

        function resetSimulation() {
            agent_id_center = -1;
            agent1 = -1;
            agent2 = -1;
            // cancelAnimationFrame(animationId);
            sim.reset();
            // agents = sim.getAgents();
            // updateSimulation();
        }
        function setSpeed(speed){
            sim.setSpeed(speed/2);
            speedIndicator.textContent = speed/2;
            // console.log(speed.value);
        }
        function setPerceptionRadius(radius){
            sim.setPerceptionRadius(radius);
            // perceptionIndicator.textContent = radius;
            // console.log(speed.value);
        }
        function setNumAgents(input){
            agent_id_center = -1;
            agent1 = -1;
            agent2 = -1;
            sim.setNumAgents(input);
            agents = sim.getAgents();
            numAgentsIndicator.textContent = input;
            // console.log(speed.value);
        }
        setTimeout(updateSimulation, 20);
        animationId = requestAnimationFrame(drawAgents);
        // speedInput.addEventListener('input', setSpeed);
        resetBtn.addEventListener('click', resetSimulation);
        ctx.restore()
    };
</script>
</body>
</html>